<!DOCTYPE html><html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNA Viewer – 23andMe (nur lokal, client‑seitig)</title>
  <meta name="description" content="Lade deine 23andMe-Rohdaten (.txt) und erkunde sie sicher im Browser. Keine Server-Uploads.">
  <style>
    :root{
      --bg:#0b0d10; --bg2:#11151a; --fg:#e7edf3; --muted:#a9b5c1; --acc:#67b7ff; --card:#0f141a; --ok:#1bbf72; --warn:#e3b341; --bad:#ff5d5d;
      --br:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(10,12,15,.8);backdrop-filter:blur(6px);border-bottom:1px solid #1b222b}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns: 340px 1fr}}
    .card{background:var(--card);border:1px solid #1b222b;border-radius:var(--br);padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-weight:600;color:var(--muted)}
    input[type=file],select,button,input[type=text]{background:#0e1217;color:var(--fg);border:1px solid #1c2630;border-radius:12px;padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:var(--acc);color:#041320;border:none}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #24303b;border-radius:999px;color:var(--muted);font-size:12px}
    #status{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0a0e12;border:1px dashed #233142;border-radius:12px;padding:10px;max-height:120px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid #1b222b;text-align:left}
    tbody tr:hover{background:#0e141a}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .card{padding:10px;text-align:center}
    .kpi h3{margin:4px 0 2px 0;font-size:18px}
    canvas{width:100%;height:180px;background:#0b1117;border:1px solid #1c2630;border-radius:12px}
    footer{opacity:.8}
    .hint{font-size:12px;color:#9fb0c1}
    .tag{font:12px ui-monospace,Consolas,monospace;background:#0c131a;border:1px solid #1b222b;border-radius:6px;padding:2px 6px}
    dialog{border:none;border-radius:14px;background:#0f1319;color:var(--fg);max-width:520px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>DNA Viewer – 23andMe (rein client‑seitig)</h1>
      <span class="pill" id="fileMeta">Keine Datei geladen</span>
      <span class="pill">Speicherung: <strong>nur lokal/temporär</strong></span>
    </div>
  </header>  <main class="wrap grid">
    <section class="card">
      <h2 style="margin-top:4px">1) Rohdaten laden</h2>
      <div class="row">
        <input id="file" type="file" accept=".txt,.tsv" />
        <button id="btnDemo" class="tag" title="Kleine Demo-Daten laden (künstlich)">Demo laden</button>
        <button id="btnReset">Zurücksetzen</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px">Wähle deine 23andMe-RAW-Datei (.txt). Die Daten werden nur im Browser verarbeitet. Nichts wird hochgeladen.</div>
      <p class="hint">Erwartetes Format: Spalten <code>rsid</code>, <code>chromosome</code>, <code>position</code>, <code>genotype</code>. Kommentarzeilen beginnen mit <code>#</code>.</p>
    </section><section class="card">
  <h2 style="margin-top:4px">2) Übersicht & Chromosomen-Dichte</h2>
  <div class="kpi">
    <div class="card"><div class="muted">SNPs gesamt</div><h3 id="kpiTotal">–</h3></div>
    <div class="card"><div class="muted">Fehlende Genotypen</div><h3 id="kpiMissing">–</h3></div>
    <div class="card"><div class="muted">Autosome : X : Y : MT</div><h3 id="kpiChroms">–</h3></div>
    <div class="card"><div class="muted">Homozygot : Heterozygot</div><h3 id="kpiZyg">–</h3></div>
  </div>
  <canvas id="ideogram" height="180" title="SNP-Dichte je Chromosom (balkenweise)"></canvas>
  <p class="hint">Visualisierung: Anzahl beobachteter SNP-Einträge pro Chromosom (nicht Länge‑skaliert). Interaktiv: Filter unten.</p>
</section>

<section class="card">
  <h2 style="margin-top:4px">3) Filtern, Suchen, Export</h2>
  <div class="toolbar">
    <label>Chromosom
      <select id="fltChr">
        <option value="">alle</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option>
        <option>12</option><option>13</option><option>14</option><option>15</option><option>16</option>
        <option>17</option><option>18</option><option>19</option><option>20</option><option>21</option><option>22</option>
        <option>X</option><option>Y</option><option>MT</option>
      </select>
    </label>
    <label>RSID
      <input id="fltRsid" type="text" placeholder="z.B. rs429358"/> 
    </label>
    <label>Genotyp
      <input id="fltGt" type="text" placeholder="AA, AG, CT …" maxlength="2"/>
    </label>
    <button id="btnExport" class="primary">Export CSV (Filter)</button>
  </div>
  <div style="margin-top:8px;max-height:300px;overflow:auto;border:1px solid #1b222b;border-radius:12px">
    <table id="tbl">
      <thead>
        <tr><th>rsid</th><th>chr</th><th>pos</th><th>genotype</th><th>Aktion</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <p class="hint">„Aktion → Simulieren“ erlaubt eine hypothetische Änderung des Genotyps, um Statistiken live zu beobachten. <strong>Kein medizinisches Urteil.</strong></p>
</section>

<section class="card">
  <h2 style="margin-top:4px">Datenschutz & Haftung</h2>
  <ul>
    <li>Verarbeitung findet ausschließlich im Browser statt (kein Upload).</li>
    <li>Die Datei wird nicht persistent gespeichert. Optionaler Cache via <code>IndexedDB</code> ist deaktiviert.</li>
    <li>Keine medizinische Interpretation. Die Anzeige dient Lern- und Explorationszwecken.</li>
  </ul>
  <footer class="muted">Tipp: Erstelle bei GitHub ein neues Repo, aktiviere „Pages“, lege diese <code>index.html</code> in den <code>main</code>-Branch an – fertig.</footer>
</section>

  </main>  <dialog id="dlg">
    <form method="dialog">
      <h3>Hypothetische Genotyp‑Änderung</h3>
      <div id="dlgBody" class="muted"></div>
      <div class="modal-actions">
        <button value="cancel">Abbrechen</button>
        <button id="dlgApply" value="apply" class="primary">Anwenden</button>
      </div>
    </form>
  </dialog>  <script>
  // --- Utility & State ---
  const E = sel => document.querySelector(sel);
  const TBL = E('#tbl tbody');
  const S = {
    rowsOriginal: [],   // Originale Datensätze
    rowsActive: [],     // Aktueller Arbeitsstand inkl. hypothetischer Änderungen
    density: {},        // Dichte pro Chromosom
    fileName: null,
  };

  function log(msg){
    const el = E('#status');
    el.textContent += ("\n"+msg);
    el.scrollTop = el.scrollHeight;
  }

  function parse23andMe(text){
    const lines = text.split(/\r?\n/);
    const rows = [];
    for(const line of lines){
      if(!line || line[0]==='#') continue;
      const parts = line.split(/\t|\s+/);
      if(parts.length < 4) continue;
      const [rsid, chromosome, position, genotypeRaw] = parts;
      const genotype = (genotypeRaw || '').trim().toUpperCase();
      rows.push({ rsid, chromosome, position: Number(position), genotype });
    }
    return rows;
  }

  function computeKPIs(rows){
    const total = rows.length;
    const missing = rows.filter(r=>!r.genotype || r.genotype==='--').length;
    const chrCounts = { '1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'X':0,'Y':0,'MT':0 };
    const zyg = { hom:0, het:0 };
    for(const r of rows){
      if(chrCounts[r.chromosome]!==undefined) chrCounts[r.chromosome]++;
      const gt = r.genotype;
      if(gt && gt.length===2){ zyg[ gt[0]===gt[1] ? 'hom':'het' ]++; }
    }
    E('#kpiTotal').textContent = total.toLocaleString('de-DE');
    E('#kpiMissing').textContent = missing.toLocaleString('de-DE');
    E('#kpiChroms').textContent = `${sumChr(chrCounts, true)} : ${chrCounts['X']} : ${chrCounts['Y']} : ${chrCounts['MT']}`;
    E('#kpiZyg').textContent = `${zyg.hom.toLocaleString('de-DE')} : ${zyg.het.toLocaleString('de-DE')}`;
    S.density = chrCounts;
  }
  function sumChr(cc, autosomesOnly){
    let s=0; for(const k of Object.keys(cc)){
      if(autosomesOnly && (k==='X'||k==='Y'||k==='MT')) continue; s+=cc[k];
    } return s;
  }

  function renderTable(rows){
    TBL.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.rsid}</td><td>${r.chromosome}</td><td>${r.position}</td><td>${r.genotype||''}</td>
        <td><button class="tag" data-rsid="${r.rsid}">Simulieren</button></td>`;
      frag.appendChild(tr);
    }
    TBL.appendChild(frag);
  }

  function drawIdeogram(){
    const c = E('#ideogram'); const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const keys = ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','X','Y','MT'];
    const W = c.clientWidth, H = c.clientHeight; const pad=14;
    const barW = (W - pad*2) / keys.length * 0.7; const step = (W - pad*2)/keys.length;
    const max = Math.max(1, ...keys.map(k=>S.density[k]||0));
    ctx.font = '12px ui-monospace,Consolas,monospace'; ctx.fillStyle = '#9fb0c1';
    keys.forEach((k,i)=>{
      const x = pad + i*step + (step-barW)/2; const v = S.density[k]||0; const h = Math.round((H-40) * (v/max));
      // bar
      ctx.fillStyle = '#203041'; ctx.fillRect(x, H-22-h, barW, h);
      // label
      ctx.fillStyle = '#9fb0c1'; ctx.fillText(k, x+barW/2-6, H-6);
    });
  }

  function applyFilters(){
    const chr = E('#fltChr').value.trim();
    const rsid = E('#fltRsid').value.trim().toLowerCase();
    const gt = E('#fltGt').value.trim().toUpperCase();
    let rows = S.rowsActive;
    if(chr) rows = rows.filter(r=>r.chromosome===chr);
    if(rsid) rows = rows.filter(r=>r.rsid.toLowerCase().includes(rsid));
    if(gt) rows = rows.filter(r=>r.genotype===gt);
    renderTable(rows.slice(0,5000)); // Sicherheitslimit fürs DOM
  }

  function exportCSV(){
    // Exportiere den aktuell gefilterten Ausschnitt
    const chr = E('#fltChr').value.trim();
    const rsid = E('#fltRsid').value.trim().toLowerCase();
    const gt = E('#fltGt').value.trim().toUpperCase();
    let rows = S.rowsActive;
    if(chr) rows = rows.filter(r=>r.chromosome===chr);
    if(rsid) rows = rows.filter(r=>r.rsid.toLowerCase().includes(rsid));
    if(gt) rows = rows.filter(r=>r.genotype===gt);
    const header = 'rsid,chromosome,position,genotype\n';
    const csv = header + rows.map(r=>`${r.rsid},${r.chromosome},${r.position},${r.genotype}`).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dna_export_${Date.now()}.csv`;
    a.click(); URL.revokeObjectURL(a.href);
  }

  // --- Hypothetische Simulation ---
  let simTarget = null;
  function openSimModal(rsid){
    const row = S.rowsActive.find(r=>r.rsid===rsid);
    if(!row) return;
    simTarget = row;
    const dlg = E('#dlg');
    E('#dlgBody').innerHTML = `
      <div class="row"><div class="muted">rsid</div><div class="tag">${row.rsid}</div></div>
      <div class="row"><div class="muted">Chromosom</div><div class="tag">${row.chromosome}</div>
      <div class="muted">Position</div><div class="tag">${row.position}</div></div>
      <label>Neuer (hypothetischer) Genotyp
        <input id="newGt" type="text" maxlength="2" placeholder="AA, AG, CT …" value="${row.genotype||''}">
      </label>
      <p class="hint">Diese Änderung ist nur temporär (in‑memory) und beeinflusst ausschließlich die hier gezeigten Statistiken.</p>`;
    dlg.showModal();
  }
  E('#dlgApply').addEventListener('click', (ev)=>{
    ev.preventDefault();
    const val = (E('#newGt').value||'').toUpperCase().replace(/[^ACGT-]/g,'').slice(0,2);
    if(!simTarget) return;
    simTarget.genotype = val;
    computeKPIs(S.rowsActive);
    drawIdeogram();
    applyFilters();
    E('#dlg').close('apply');
  });

  // --- File handling ---
  E('#file').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f){return}
    S.fileName = f.name;
    E('#fileMeta').textContent = `Datei: ${f.name} (${(f.size/1e6).toFixed(2)} MB)`;
    log(`Lese Datei …`);
    const text = await f.text();
    const rows = parse23andMe(text);
    if(!rows.length){ log('Keine verwertbaren Zeilen gefunden. Prüfe Dateiformat.'); return; }
    S.rowsOriginal = rows.map(r=>({...r}));
    S.rowsActive   = rows.map(r=>({...r}));
    log(`Importiert: ${rows.length.toLocaleString('de-DE')} SNP‑Zeilen.`);
    computeKPIs(S.rowsActive);
    drawIdeogram();
    applyFilters();
  });

  E('#btnReset').addEventListener('click', ()=>{
    S.rowsActive = S.rowsOriginal.map(r=>({...r}));
    computeKPIs(S.rowsActive); drawIdeogram(); applyFilters();
    log('Zurückgesetzt auf Originalzustand.');
  });

  E('#btnDemo').addEventListener('click', ()=>{
    // kleine künstliche Demo-Daten (~200 Zeilen) zum Testen
    const chroms = ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','X','Y','MT'];
    const nts = ['A','C','G','T'];
    const make = (i)=>{
      const c = chroms[i % chroms.length];
      const g = nts[i%4] + nts[(i+1)%4];
      return { rsid:`rs${100000+i}`, chromosome:c, position: 1000+i*7, genotype:g };
    };
    const rows = Array.from({length:220}, (_,i)=>make(i));
    S.rowsOriginal = rows.map(r=>({...r}));
    S.rowsActive   = rows.map(r=>({...r}));
    S.fileName = 'demo_data.synthetic.txt';
    E('#fileMeta').textContent = `Datei: ${S.fileName}`;
    log('Demo-Daten geladen.');
    computeKPIs(S.rowsActive); drawIdeogram(); applyFilters();
  });

  E('#fltChr').addEventListener('change', applyFilters);
  E('#fltRsid').addEventListener('input', applyFilters);
  E('#fltGt').addEventListener('input', applyFilters);
  E('#btnExport').addEventListener('click', exportCSV);

  TBL.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-rsid]');
    if(btn){ openSimModal(btn.dataset.rsid); }
  });

  // Initial draw baseline
  computeKPIs([]); drawIdeogram();
  </script></body>
</html>
