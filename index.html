<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNA Viewer – 23andMe (nur lokal, client-seitig)</title>
  <meta name="description" content="Lade deine 23andMe-Rohdaten (.txt) und erkunde sie sicher im Browser. Keine Server-Uploads.">
  <style>
    :root{
      --bg:#0b0d10; --bg2:#11151a; --fg:#e7edf3; --muted:#a9b5c1; --acc:#67b7ff; --card:#0f141a; --ok:#1bbf72; --warn:#e3b341; --bad:#ff5d5d;
      --br:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(10,12,15,.8);backdrop-filter:blur(6px);border-bottom:1px solid #1b222b}
    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .grid{display:grid;gap:16px}
    @media(min-width:1120px){.grid{grid-template-columns: 380px 1fr}}
    .card{background:var(--card);border:1px solid #1b222b;border-radius:var(--br);padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-weight:600;color:var(--muted)}
    input[type=file],select,button,input[type=text],input[type=number],input[type=checkbox]{background:#0e1217;color:var(--fg);border:1px solid #1c2630;border-radius:12px;padding:10px 12px}
    input[type=checkbox]{width:auto;padding:0;margin:0 6px 0 0}
    button{cursor:pointer}
    button.primary{background:var(--acc);color:#041320;border:none}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #24303b;border-radius:999px;color:var(--muted);font-size:12px}
    #status{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0a0e12;border:1px dashed #233142;border-radius:12px;padding:10px;max-height:140px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid #1b222b;text-align:left;vertical-align:top}
    tbody tr:hover{background:#0e141a}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .card{padding:10px;text-align:center}
    .kpi h3{margin:4px 0 2px 0;font-size:18px}
    canvas{width:100%;height:200px;background:#0b1117;border:1px solid #1c2630;border-radius:12px}
    footer{opacity:.8}
    .hint{font-size:12px;color:#9fb0c1}
    .tag{font:12px ui-monospace,Consolas,monospace;background:#0c131a;border:1px solid #1b222b;border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid #274357;background:#0b1420;color:#b9d9ff;font:12px ui-monospace}
    .bookmark{cursor:pointer;border:1px solid #2a3a4a;border-radius:8px;padding:2px 6px;background:#0c1218}
    .bookmark.active{outline:2px solid #67b7ff66}
    .panel{background:#0b1016;border:1px solid #1b222b;border-radius:12px;padding:10px}
    dialog{border:none;border-radius:14px;background:#0f1319;color:var(--fg);max-width:560px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .split{display:grid;gap:12px}
    @media(min-width:720px){.split{grid-template-columns:1fr 1fr}}
    /* Genomweite Visualisierung höher */
    #genomeCanvas{height:620px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>DNA Viewer – 23andMe (rein client-seitig)</h1>
      <span class="pill" id="fileMeta">Keine Datei geladen</span>
      <span class="pill">Speicherung: <strong>nur lokal/temporär</strong></span>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2 style="margin-top:4px">1) Rohdaten laden</h2>
      <div class="row">
        <input id="file" type="file" accept=".txt,.tsv" />
        <button id="btnDemo" class="tag" title="Kleine Demo-Daten laden (künstlich)">Demo laden</button>
        <button id="btnReset">Zurücksetzen</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px">Wähle deine 23andMe-RAW-Datei (.txt). Die Daten werden nur im Browser verarbeitet. Nichts wird hochgeladen.</div>
      <p class="hint">Erwartetes Format: Spalten <code>rsid</code>, <code>chromosome</code>, <code>position</code>, <code>genotype</code>. Kommentarzeilen beginnen mit <code>#</code>.</p>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">2) Übersicht & Chromosomen-Dichte</h2>
      <div class="kpi">
        <div class="card"><div class="muted">SNPs gesamt</div><h3 id="kpiTotal">–</h3></div>
        <div class="card"><div class="muted">Fehlende Genotypen</div><h3 id="kpiMissing">–</h3></div>
        <div class="card"><div class="muted">Autosome : X : Y : MT</div><h3 id="kpiChroms">–</h3></div>
        <div class="card"><div class="muted">Homozygot : Heterozygot</div><h3 id="kpiZyg">–</h3></div>
      </div>
      <canvas id="ideogram" height="200" title="SNP-Dichte je Chromosom (balkenweise)"></canvas>
      <p class="hint">Klicke einen Balken an, um unten in den Chromosom-Zoom zu springen.</p>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">3) Filtern, Suchen, Export</h2>
      <div class="toolbar">
        <label>Chromosom
          <select id="fltChr">
            <option value="">alle</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option>
            <option>12</option><option>13</option><option>14</option><option>15</option><option>16</option>
            <option>17</option><option>18</option><option>19</option><option>20</option><option>21</option><option>22</option>
            <option>X</option><option>Y</option><option>MT</option>
          </select>
        </label>
        <label>RSID
          <input id="fltRsid" type="text" placeholder="z.B. rs429358"/>
        </label>
        <label>Genotyp
          <input id="fltGt" type="text" placeholder="AA, AG, CT …" maxlength="2"/>
        </label>
        <button id="btnExport" class="primary">Export CSV (Filter)</button>
      </div>
      <div style="margin-top:8px;max-height:300px;overflow:auto;border:1px solid #1b222b;border-radius:12px">
        <table id="tbl">
          <thead>
            <tr><th>★</th><th>rsid</th><th>chr</th><th>pos</th><th>genotype</th><th>Annotation</th><th>Aktion</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">„Aktion → Simulieren“ ändert einen Eintrag temporär (in-memory). <strong>Kein medizinisches Urteil.</strong></p>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">4) Annotation & Bookmarks</h2>
      <div class="split">
        <div class="panel">
          <div class="row">
            <label>Annotation-Liste (lokal, frei)
              <input id="annFile" type="file" accept=".csv,.tsv,.txt" />
            </label>
            <button id="btnAnnDemo" class="tag" title="Kleine Demo-Annotation laden">Demo</button>
          </div>
          <p class="hint">Erwartete Spalten (flexibel, Header-unabhängig erkannt):
            <code>rsid</code>, optional <code>label</code>/<code>name</code>, optional <code>source</code>/<code>url</code>. Trennung: CSV/TSV.
          </p>
          <div class="row">
            <span class="badge" id="annCount">0 Annotationen</span>
            <label class="row" style="align-items:center"><input id="chkOnlyAnnotated" type="checkbox" />nur annotierte anzeigen</label>
          </div>
        </div>
        <div class="panel">
          <div class="row" style="justify-content:space-between;width:100%">
            <strong>RSID-Bookmarks</strong>
            <label class="row" style="align-items:center"><input id="chkPersist" type="checkbox"/>persistente Speicherung (localStorage)</label>
          </div>
          <div id="bmList" class="muted" style="margin-top:8px;max-height:160px;overflow:auto"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">5) Chromosom-Zoom (Kachel-Histogramm)</h2>
      <div class="toolbar">
        <span class="muted">Ausgewählt: <span id="zoomChr" class="badge">–</span></span>
        <label>Bins <input id="bins" type="text" value="60" style="width:70px"/></label>
        <button id="btnRedraw" class="tag">Neu zeichnen</button>
      </div>
      <canvas id="zoomCanvas" height="260" title="Dichte-Heatmap über Positionen im gewählten Chromosom"></canvas>
      <div id="zoomInfo" class="hint" style="margin-top:6px">Tipp: Wähle oben im Ideogramm ein Chromosom oder nutze den Filter.</div>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">6) Genom-Visualisierung (alle Chromosomen)</h2>
      <div class="toolbar">
        <label>Modus
          <select id="vizMode">
            <option value="heat">Heatmap (Bins)</option>
            <option value="scatter">Scatter (Punkte)</option>
          </select>
        </label>
        <label>Bins/Chrom <input id="vizBins" type="number" min="10" max="1000" value="120" style="width:90px"/></label>
        <label>Max-Punkte (Scatter) <input id="vizMaxPts" type="number" min="1000" max="400000" value="120000" style="width:110px"/></label>
        <label class="row" style="align-items:center"><input id="vizHiAnn" type="checkbox">annotierte hervorheben</label>
      </div>
      <canvas id="genomeCanvas" height="620" title="Genomweite Darstellung deiner geladenen Datei (client-seitig)"></canvas>
      <div id="genomeInfo" class="hint" style="margin-top:6px">Hover zeigt Bereich; Klick auf eine Zeile öffnet den Chromosom-Zoom. Filter wirken auch hier.</div>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">Datenschutz & Haftung</h2>
      <ul>
        <li>Verarbeitung findet ausschließlich im Browser statt (kein Upload).</li>
        <li>Die Datei wird nicht persistent gespeichert. Bookmarks sind optional persistent (opt-in lokal).</li>
        <li>Keine medizinische Interpretation. Die Anzeige dient Lern- und Explorationszwecken.</li>
      </ul>
      <footer class="muted">Tipp: Erstelle bei GitHub ein neues Repo, aktiviere „Pages“, lege diese <code>index.html</code> in den <code>main</code>-Branch – fertig.</footer>
    </section>
  </main>

  <dialog id="dlg">
    <form method="dialog">
      <h3>Hypothetische Genotyp-Änderung</h3>
      <div id="dlgBody" class="muted"></div>
      <div class="modal-actions">
        <button value="cancel">Abbrechen</button>
        <button id="dlgApply" value="apply" class="primary">Anwenden</button>
      </div>
    </form>
  </dialog>

  <script>
  // --- Utility & State ---
  const E = sel => document.querySelector(sel);
  const TBL = E('#tbl tbody');
  const S = {
    rowsOriginal: [],
    rowsActive: [],
    density: {},
    fileName: null,
    annotations: new Map(), // rsid -> {label, source}
    bookmarks: new Set(),   // RSID-Bookmarks
    zoomChrom: null,
  };

  function log(msg){ const el = E('#status'); el.textContent += ("\n"+msg); el.scrollTop = el.scrollHeight; }
  function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function sanitizeCsv(s){ return '"'+String(s).replace(/"/g,'""')+'"'; }

  // --- Parsing 23andMe ---
  function parse23andMe(text){
    const lines = text.split(/\r?\n/); const rows = [];
    for(const line of lines){
      if(!line || line[0]==='#') continue;
      const parts = line.split(/\t|\s+/); if(parts.length < 4) continue;
      const [rsid, chromosome, position, genotypeRaw] = parts;
      const genotype = (genotypeRaw||'').trim().toUpperCase();
      rows.push({ rsid, chromosome, position: Number(position), genotype });
    }
    return rows;
  }

  // --- KPIs ---
  function computeKPIs(rows){
    const total = rows.length; const missing = rows.filter(r=>!r.genotype || r.genotype==='--').length;
    const chrCounts = { '1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'X':0,'Y':0,'MT':0 };
    const zyg = { hom:0, het:0 };
    for(const r of rows){ if(chrCounts[r.chromosome]!==undefined) chrCounts[r.chromosome]++; const gt=r.genotype; if(gt && gt.length===2){ zyg[ gt[0]===gt[1] ? 'hom':'het' ]++; } }
    E('#kpiTotal').textContent = total.toLocaleString('de-DE');
    E('#kpiMissing').textContent = missing.toLocaleString('de-DE');
    E('#kpiChroms').textContent = `${sumChr(chrCounts, true)} : ${chrCounts['X']} : ${chrCounts['Y']} : ${chrCounts['MT']}`;
    E('#kpiZyg').textContent = `${zyg.hom.toLocaleString('de-DE')} : ${zyg.het.toLocaleString('de-DE')}`;
    S.density = chrCounts;
  }
  function sumChr(cc, autosomesOnly){ let s=0; for(const k of Object.keys(cc)){ if(autosomesOnly && (k==='X'||k==='Y'||k==='MT')) continue; s+=cc[k]; } return s; }

  // --- Annotation & Table ---
  function rowAnnotation(rsid){
    const a = S.annotations.get(rsid); if(!a) return '';
    const src = a.source ? `<br><span class="hint">${escapeHtml(a.source)}</span>`:'';
    return `<strong>${escapeHtml(a.label||'annotiert')}</strong>${src}`;
  }

  function renderTable(rows){
    TBL.innerHTML = '';
    const onlyAnn = E('#chkOnlyAnnotated')?.checked;
    const frag = document.createDocumentFragment();
    for(const r of rows){
      if(onlyAnn && !S.annotations.has(r.rsid)) continue;
      const ann = rowAnnotation(r.rsid); const starred = S.bookmarks.has(r.rsid) ? '★' : '☆';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><button class="bookmark ${S.bookmarks.has(r.rsid)?'active':''}" data-bm="${r.rsid}" title="Bookmark umschalten">${starred}</button></td>
        <td>${r.rsid}</td><td>${r.chromosome}</td><td>${r.position}</td><td>${r.genotype||''}</td>
        <td>${ann}</td>
        <td><button class="tag" data-rsid="${r.rsid}">Simulieren</button></td>`;
      frag.appendChild(tr);
    }
    TBL.appendChild(frag);
    drawBmList();
  }

  // --- Ideogram ---
  function drawIdeogram(){
    const c = E('#ideogram'); const ctx = c.getContext('2d'); const dpr = window.devicePixelRatio||1; c.width = c.clientWidth*dpr; c.height = c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    const keys = ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','X','Y','MT'];
    const W = c.clientWidth, H = c.clientHeight; const pad=14; const barW = (W - pad*2) / keys.length * 0.7; const step = (W - pad*2)/keys.length; const max = Math.max(1, ...keys.map(k=>S.density[k]||0));
    ctx.font = '12px ui-monospace,Consolas,monospace'; ctx.fillStyle = '#9fb0c1';
    c.onclick = null;
    c.addEventListener('click',(ev)=>{
      const rect = c.getBoundingClientRect(); const mx = ev.clientX - rect.left; const my = ev.clientY - rect.top;
      keys.forEach((k,i)=>{
        const x = pad + i*step + (step-barW)/2; const v = S.density[k]||0; const h = Math.round((H-40) * (v/max)); const bx=x, by=H-22-h, bw=barW, bh=h+20;
        if(mx>=bx && mx<=bx+bw && my>=by-20 && my<=by+bh){ setZoomChrom(k); }
      });
    });
    keys.forEach((k,i)=>{
      const x = pad + i*step + (step-barW)/2; const v = S.density[k]||0; const h = Math.round((H-40) * (v/max)); ctx.fillStyle = '#203041'; ctx.fillRect(x, H-22-h, barW, h); ctx.fillStyle = '#9fb0c1'; ctx.fillText(k, x+barW/2-6, H-6);
    });
  }

  // --- Zoom Heatmap ---
  function setZoomChrom(chr){ S.zoomChrom = chr; E('#zoomChr').textContent = chr||'–'; drawZoom(); }

  function drawZoom(){
    const c = E('#zoomCanvas'); const ctx = c.getContext('2d'); const dpr = window.devicePixelRatio||1; c.width = c.clientWidth*dpr; c.height = c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    const chr = S.zoomChrom || E('#fltChr').value || '1'; E('#zoomChr').textContent = chr;
    const bins = Math.max(5, Math.min(400, parseInt(E('#bins').value)||60));
    const rows = S.rowsActive.filter(r=>r.chromosome===chr);
    if(!rows.length){ ctx.font='14px sans-serif'; ctx.fillStyle='#9fb0c1'; ctx.fillText('Keine Daten für dieses Chromosom.', 10, 24); return; }
    const minPos = Math.min(...rows.map(r=>r.position)); const maxPos = Math.max(...rows.map(r=>r.position)); const binSize = (maxPos - minPos + 1) / bins; const counts = new Array(bins).fill(0);
    for(const r of rows){ const idx = Math.max(0, Math.min(bins-1, Math.floor((r.position - minPos)/binSize))); counts[idx]++; }
    const W = c.clientWidth, H = c.clientHeight; const pad=12; const tileW = (W - pad*2) / bins; const maxC = Math.max(1, ...counts); const baseY = H - 28; const maxH = H - 58;
    ctx.font='12px ui-monospace,Consolas,monospace';
    for(let i=0;i<bins;i++){ const x = pad + i*tileW; const t = counts[i]/maxC; const h = Math.max(2, Math.round(maxH * t)); ctx.fillStyle = `rgba(103,183,255,${(0.15 + t*0.75).toFixed(3)})`; ctx.fillRect(x, baseY - h, Math.max(1, tileW-1), h); }
    ctx.strokeStyle = '#203041'; ctx.beginPath(); ctx.moveTo(pad, baseY+0.5); ctx.lineTo(W-pad, baseY+0.5); ctx.stroke(); ctx.fillStyle = '#9fb0c1'; ctx.fillText(`${minPos.toLocaleString('de-DE')}`, pad, H-8); ctx.fillText(`${maxPos.toLocaleString('de-DE')}`, W-80, H-8);
    c.onmousemove = (ev)=>{ const rect = c.getBoundingClientRect(); const mx = ev.clientX - rect.left; const i = Math.max(0, Math.min(bins-1, Math.floor((mx - pad)/tileW))); const start = Math.round(minPos + i*binSize); const end = Math.round(start + binSize - 1); E('#zoomInfo').textContent = `Bin ${i+1}/${bins}: Position ${start.toLocaleString('de-DE')}–${end.toLocaleString('de-DE')} | SNPs: ${counts[i].toLocaleString('de-DE')}`; };
  }

  // --- Filters & Export ---
  function applyFilters(){
    const chr = E('#fltChr').value.trim(); const rsid = E('#fltRsid').value.trim().toLowerCase(); const gt = E('#fltGt').value.trim().toUpperCase();
    let rows = S.rowsActive;
    if(chr){ rows = rows.filter(r=>r.chromosome===chr); setZoomChrom(chr); }
    if(rsid) rows = rows.filter(r=>r.rsid.toLowerCase().includes(rsid));
    if(gt) rows = rows.filter(r=>r.genotype===gt);
    renderTable(rows.slice(0,6000)); // DOM-Limit
  }

  function exportCSV(){
    const chr = E('#fltChr').value.trim(); const rsid = E('#fltRsid').value.trim().toLowerCase(); const gt = E('#fltGt').value.trim().toUpperCase();
    let rows = S.rowsActive; if(chr) rows = rows.filter(r=>r.chromosome===chr); if(rsid) rows = rows.filter(r=>r.rsid.toLowerCase().includes(rsid)); if(gt) rows = rows.filter(r=>r.genotype===gt); if(E('#chkOnlyAnnotated').checked){ rows = rows.filter(r=>S.annotations.has(r.rsid)); }
    const header = 'rsid,chromosome,position,genotype,label,source\n';
    const csv = header + rows.map(r=>{ const a=S.annotations.get(r.rsid)||{}; return `${r.rsid},${r.chromosome},${r.position},${r.genotype||''},${sanitizeCsv(a.label||'')},${sanitizeCsv(a.source||'')}`; }).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `dna_export_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // --- Hypothetische Simulation ---
  let simTarget = null;
  function openSimModal(rsid){
    const row = S.rowsActive.find(r=>r.rsid===rsid); if(!row) return; simTarget = row; const dlg = E('#dlg'); E('#dlgBody').innerHTML = `
      <div class="row"><div class="muted">rsid</div><div class="tag">${row.rsid}</div></div>
      <div class="row"><div class="muted">Chromosom</div><div class="tag">${row.chromosome}</div>
      <div class="muted">Position</div><div class="tag">${row.position}</div></div>
      <label>Neuer (hypothetischer) Genotyp
        <input id="newGt" type="text" maxlength="2" placeholder="AA, AG, CT …" value="${row.genotype||''}">
      </label>
      <p class="hint">Diese Änderung ist nur temporär (in-memory) und beeinflusst ausschließlich die hier gezeigten Statistiken.</p>`; dlg.showModal();
  }
  E('#dlgApply').addEventListener('click', (ev)=>{ ev.preventDefault(); const val = (E('#newGt').value||'').toUpperCase().replace(/[^ACGT-]/g,'').slice(0,2); if(!simTarget) return; simTarget.genotype = val; computeKPIs(S.rowsActive); drawIdeogram(); applyFilters(); rebuildGenomeIndex(); drawGenome(); E('#dlg').close('apply'); });

  // --- Bookmarks ---
  function toggleBookmark(rsid){ if(S.bookmarks.has(rsid)) S.bookmarks.delete(rsid); else S.bookmarks.add(rsid); persistBookmarksMaybe(); applyFilters(); rebuildGenomeIndex(); drawGenome(); }
  function drawBmList(){ const el = E('#bmList'); if(!S.bookmarks.size){ el.innerHTML = '<span class="muted">keine Bookmarks</span>'; return; } el.innerHTML=''; S.bookmarks.forEach(rs=>{ const div=document.createElement('div'); const ann=S.annotations.get(rs); div.innerHTML = `<span class="tag">${rs}</span> ${ann?('<span class="hint">'+escapeHtml(ann.label||'')+'</span>'):''} <button class="tag" data-jump="${rs}">anzeigen</button> <button class="tag" data-delbm="${rs}">entfernen</button>`; el.appendChild(div); }); }
  function persistBookmarksMaybe(){ if(!E('#chkPersist').checked) return; try{ localStorage.setItem('dna_bm', JSON.stringify([...S.bookmarks])); }catch{} }
  function restoreBookmarks(){ try{ const arr = JSON.parse(localStorage.getItem('dna_bm')||'[]'); if(Array.isArray(arr)) arr.forEach(r=>S.bookmarks.add(r)); }catch{} }

  // --- Annotation Import ---
  async function loadAnnotationText(text){
    const lines = text.split(/\r?\n/).filter(Boolean); if(!lines.length) return 0; const delim = lines[0].includes('\t')? '\t' : ',';
    let rsIdx=0, labelIdx=null, srcIdx=null; const header = lines[0].split(new RegExp(delim)).map(s=>s.trim().toLowerCase()); const isHeader = header.some(h=>h.includes('rsid')||h.includes('label')||h.includes('name')); let start = 0; if(isHeader){ for(let i=0;i<header.length;i++){ const h=header[i]; if(h.includes('rsid')) rsIdx=i; if(labelIdx===null && (h.includes('label')||h.includes('name'))) labelIdx=i; if(srcIdx===null && (h.includes('source')||h.includes('url')||h.includes('ref'))) srcIdx=i; } start = 1; }
    let n=0; for(let i=start;i<lines.length;i++){ const parts = lines[i].split(new RegExp(delim)); const rs=(parts[rsIdx]||'').trim(); if(!rs) continue; const label=(labelIdx!=null?parts[labelIdx]:null)||''; const source=(srcIdx!=null?parts[srcIdx]:null)||''; S.annotations.set(rs, {label: String(label).trim(), source: String(source).trim()}); n++; }
    E('#annCount').textContent = `${S.annotations.size} Annotationen`; applyFilters(); rebuildGenomeIndex(); drawGenome(); return n;
  }

  // --- Genom-Visualisierung (Section 6) ---
  const G = { layout:{ rowH:22, gap:8, padX:14, top:18 }, perChr:new Map() };

  function currentFilteredForGenome(){
    const chr = E('#fltChr')?.value?.trim()||'';
    const rsid = E('#fltRsid')?.value?.trim().toLowerCase()||'';
    const gt = E('#fltGt')?.value?.trim().toUpperCase()||'';
    let rows = S.rowsActive;
    if(chr) rows = rows.filter(r=>r.chromosome===chr);
    if(rsid) rows = rows.filter(r=>r.rsid.toLowerCase().includes(rsid));
    if(gt) rows = rows.filter(r=>r.genotype===gt);
    if(E('#chkOnlyAnnotated')?.checked) rows = rows.filter(r=>S.annotations.has(r.rsid));
    return rows;
  }

  function rebuildGenomeIndex(){
    G.perChr.clear();
    const rows = currentFilteredForGenome();
    const chroms = ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','X','Y','MT'];
    for(const c of chroms){
      const subset = rows.filter(r=>r.chromosome===c);
      if(!subset.length){ G.perChr.set(c,{rows:[],min:0,max:1}); continue; }
      const min = Math.min(...subset.map(r=>r.position));
      const max = Math.max(...subset.map(r=>r.position));
      G.perChr.set(c,{rows:subset,min,max});
    }
  }

  function drawGenome(){
    const c = E('#genomeCanvas'); if(!c) return;
    const ctx = c.getContext('2d');
    const dpr = window.devicePixelRatio||1; c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);

    const mode = E('#vizMode').value;
    const bins = Math.max(10, Math.min(1000, parseInt(E('#vizBins').value)||120));
    const hiAnn = E('#vizHiAnn').checked;

    const W=c.clientWidth, padX=G.layout.padX;
    const rowH=G.layout.rowH, gap=G.layout.gap, top=G.layout.top;
    const chroms=['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','X','Y','MT'];

    ctx.font='12px ui-monospace,Consolas,monospace'; ctx.fillStyle='#9fb0c1';
    const hit=[];

    chroms.forEach((chr,idx)=>{
      const y0=top+idx*(rowH+gap);
      const yMid=y0+rowH/2;
      ctx.fillStyle='#9fb0c1'; ctx.fillText(chr, 4, yMid+4);

      const x0=padX+28, x1=W - padX, w=x1-x0;
      ctx.fillStyle='#12202c'; ctx.fillRect(x0, yMid-1, w, 2);

      const info = G.perChr.get(chr)||{rows:[],min:0,max:1};
      if(!info.rows.length){ hit.push({chr,y0:y0,y1:y0+rowH}); return; }

      if(mode==='heat'){
        const binSize=(info.max-info.min+1)/bins;
        const counts=new Array(bins).fill(0);
        if(binSize>0){
          for(const r of info.rows){
            const i=Math.max(0,Math.min(bins-1, Math.floor((r.position-info.min)/binSize)));
            counts[i]++;
          }
        }
        const maxC=Math.max(1,...counts);
        for(let i=0;i<bins;i++){
          const t=counts[i]/maxC;
          const col=`rgba(103,183,255,${(0.12+0.78*t).toFixed(3)})`;
          const tx=x0 + (i/bins)*w; const tw=Math.max(1, w/bins - 0.5);
          const th=Math.max(2, Math.round((rowH-6)*t));
          ctx.fillStyle=col; ctx.fillRect(tx, yMid - th/2, tw, th);
        }
        ctx.fillStyle='#62707e'; ctx.fillRect(x0, yMid-1, 1, 2); ctx.fillRect(x1-1, yMid-1, 1, 2);
      } else {
        const maxPts = Math.max(1000, Math.min(400000, parseInt(E('#vizMaxPts').value)||120000));
        const n=info.rows.length;
        const step=Math.max(1, Math.floor(n/Math.min(n, Math.floor(maxPts/24))));
        let j=0;
        for(const r of info.rows){
          if((j++ % step)!==0) continue;
          const t = (r.position - info.min) / Math.max(1,(info.max-info.min));
          const x = x0 + t*w;
          const y = yMid + (Math.random()*0.75 - 0.375) * (rowH-6);
          const annotated = hiAnn && S.annotations.has(r.rsid);
          const bookmarked = S.bookmarks.has(r.rsid);
          ctx.fillStyle = bookmarked ? '#ffd166' : (annotated ? '#4ea1ff' : '#a0b3c4');
          ctx.fillRect(x, y, 1, 1);
        }
      }
      hit.push({chr, y0:y0, y1:y0+rowH, x0, x1, min:info.min, max:info.max});
    });

    c.onmousemove = (ev)=>{
      const rect=c.getBoundingClientRect(); const mx=ev.clientX-rect.left; const my=ev.clientY-rect.top;
      const zone=hit.find(h=>my>=h.y0&&my<=h.y1);
      if(!zone){ E('#genomeInfo').textContent='—'; return; }
      if(zone.x0==null){ E('#genomeInfo').textContent=`Chr ${zone.chr}: keine Daten`; return; }
      const t=Math.max(0, Math.min(1, (mx - zone.x0) / Math.max(1, zone.x1 - zone.x0)));
      const pos=Math.round(zone.min + t*(zone.max-zone.min));
      E('#genomeInfo').textContent = `Chr ${zone.chr} | Position ≈ ${pos.toLocaleString('de-DE')} | Modus: ${E('#vizMode').value}`;
    };
    c.onclick = (ev)=>{
      const rect=c.getBoundingClientRect(); const my=ev.clientY-rect.top;
      const zone=hit.find(h=>my>=h.y0&&my<=h.y1);
      if(zone){ setZoomChrom(zone.chr); window.scrollTo({top: c.offsetTop + 400, behavior:'smooth'}); }
    };
  }

  // --- Events / Glue ---
  function persistBookmarksMaybe(){ if(!E('#chkPersist').checked) return; try{ localStorage.setItem('dna_bm', JSON.stringify([...S.bookmarks])); }catch{} }

  // File handling
  E('#file').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f){return}
    S.fileName = f.name;
    E('#fileMeta').textContent = `Datei: ${f.name} (${(f.size/1e6).toFixed(2)} MB)`;
    log(`Lese Datei …`);
    const text = await f.text();
    const rows = parse23andMe(text);
    if(!rows.length){ log('Keine verwertbaren Zeilen gefunden. Prüfe Dateiformat.'); return; }
    S.rowsOriginal = rows.map(r=>({...r}));
    S.rowsActive   = rows.map(r=>({...r}));
    log(`Importiert: ${rows.length.toLocaleString('de-DE')} SNP-Zeilen.`);
    computeKPIs(S.rowsActive);
    drawIdeogram();
    applyFilters();
    rebuildGenomeIndex(); drawGenome();
  });

  E('#btnReset').addEventListener('click', ()=>{
    S.rowsActive = S.rowsOriginal.map(r=>({...r}));
    computeKPIs(S.rowsActive); drawIdeogram(); applyFilters();
    rebuildGenomeIndex(); drawGenome();
    log('Zurückgesetzt auf Originalzustand.');
  });

  E('#btnDemo').addEventListener('click', ()=>{
    // synthetische Demo (~22k SNPs) für flüssige Visualisierung
    const chroms = ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','X','Y','MT'];
    const nts = ['A','C','G','T'];
    const make = (i)=>{
      const c = chroms[i % chroms.length];
      const g = nts[i%4] + nts[(i+1)%4];
      return { rsid:`rs${100000+i}`, chromosome:c, position: 1000+i*7, genotype:g };
    };
    const rows = Array.from({length:22000}, (_,i)=>make(i));
    S.rowsOriginal = rows.map(r=>({...r}));
    S.rowsActive   = rows.map(r=>({...r}));
    S.fileName = 'demo_data.synthetic.txt';
    E('#fileMeta').textContent = `Datei: ${S.fileName}`;
    log('Demo-Daten geladen.');
    computeKPIs(S.rowsActive); drawIdeogram(); applyFilters();
    rebuildGenomeIndex(); drawGenome();
  });

  // Filters
  E('#fltChr').addEventListener('change', applyFilters);
  E('#fltRsid').addEventListener('input', applyFilters);
  E('#fltGt').addEventListener('input', applyFilters);
  E('#btnExport').addEventListener('click', exportCSV);

  // Bookmarks & jump actions (Delegation)
  TBL.addEventListener('click', (e)=>{
    const bm = e.target.closest('button[data-bm]'); if(bm){ toggleBookmark(bm.dataset.bm); return; }
    const btn = e.target.closest('button[data-rsid]'); if(btn){ openSimModal(btn.dataset.rsid); return; }
  });
  E('#bmList').addEventListener('click', (e)=>{
    const del = e.target.closest('button[data-delbm]'); if(del){ S.bookmarks.delete(del.dataset.delbm); persistBookmarksMaybe(); applyFilters(); rebuildGenomeIndex(); drawGenome(); return; }
    const j = e.target.closest('button[data-jump]'); if(j){ const rs=j.dataset.jump; const row=[...TBL.querySelectorAll('tr')].find(tr=>tr.children[1]?.textContent===rs); if(row){ row.scrollIntoView({behavior:'smooth', block:'center'}); row.style.outline='2px solid #67b7ff66'; setTimeout(()=>row.style.outline='none',1200); } }
  });
  E('#chkPersist').addEventListener('change', ()=>persistBookmarksMaybe());

  // Annotation file
  E('#annFile').addEventListener('change', async (e)=>{ const f = e.target.files?.[0]; if(!f) return; const text = await f.text(); const n = await loadAnnotationText(text); log(`Annotationen geladen: ${n}`); });
  E('#btnAnnDemo').addEventListener('click', ()=>{ const demo = `rsid,label,source\nrs429358,APOE-Epsilon-Marker (deskriptiv),Freie Liste\nrs7412,APOE-Epsilon-Marker (deskriptiv),Freie Liste\nrs9939609,FTO-Variante (deskriptiv),Offener Katalog`; loadAnnotationText(demo); });
  E('#chkOnlyAnnotated').addEventListener('change', ()=>{ applyFilters(); rebuildGenomeIndex(); drawGenome(); });

  // Genome view controls
  ;['vizMode','vizBins','vizMaxPts','vizHiAnn'].forEach(id=>{
    const el=E('#'+id); if(el) el.addEventListener('input', ()=>{ rebuildGenomeIndex(); drawGenome(); });
  });
  E('#btnRedraw').addEventListener('click', drawZoom);

  // Bookmarks helpers
  function toggleBookmark(rsid){ if(S.bookmarks.has(rsid)) S.bookmarks.delete(rsid); else S.bookmarks.add(rsid); persistBookmarksMaybe(); applyFilters(); rebuildGenomeIndex(); drawGenome(); }
  function drawBmList(){ const el = E('#bmList'); if(!S.bookmarks.size){ el.innerHTML = '<span class="muted">keine Bookmarks</span>'; return; } el.innerHTML=''; S.bookmarks.forEach(rs=>{ const div=document.createElement('div'); const ann=S.annotations.get(rs); div.innerHTML = `<span class="tag">${rs}</span> ${ann?('<span class="hint">'+escapeHtml(ann.label||'')+'</span>'):''} <button class="tag" data-jump="${rs}">anzeigen</button> <button class="tag" data-delbm="${rs}">entfernen</button>`; el.appendChild(div); }); }

  // Init
  try{ restoreBookmarks(); }catch{}
  computeKPIs([]); drawIdeogram(); applyFilters(); rebuildGenomeIndex(); drawGenome();

  </script>
</body>
</html>
