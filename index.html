<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNA Viewer – 23andMe (nur lokal, client‑seitig)</title>
  <style>
    :root{--bg:#0b0d10;--bg2:#11151a;--fg:#e7edf3;--muted:#a9b5c1;--acc:#67b7ff;--card:#0f141a;--br:16px}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(10,12,15,.8);backdrop-filter:blur(6px);border-bottom:1px solid #1b222b}
    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;gap:16px}
    @media(min-width:1120px){.grid{grid-template-columns:380px 1fr}}
    .card{background:var(--card);border:1px solid #1b222b;border-radius:var(--br);padding:14px}
    canvas{width:100%;background:#0b1117;border:1px solid #1c2630;border-radius:12px}
    .hint{font-size:12px;color:#9fb0c1}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #24303b;border-radius:999px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>DNA Viewer – 23andMe (rein client‑seitig)</h1>
      <span class="pill" id="fileMeta">Keine Datei geladen</span>
    </div>
  </header>
  <main class="wrap grid">
    <section class="card">
      <h2>1) Rohdaten laden</h2>
      <div class="row">
        <input id="file" type="file" accept=".txt,.tsv" />
      </div>
      <div id="status" class="hint">Wähle deine 23andMe-RAW-Datei. Verarbeitung erfolgt nur lokal im Browser.</div>
    </section>
    <section class="card">
      <h2>2) Übersicht & Ideogramm</h2>
      <canvas id="ideogram" height="200"></canvas>
    </section>
    <section class="card">
      <h2>3) Chromosom‑Zoom</h2>
      <canvas id="zoomCanvas" height="260"></canvas>
      <div id="zoomInfo" class="hint"></div>
    </section>
    <section class="card">
      <h2>4) Genom‑Visualisierung</h2>
      <canvas id="genomeCanvas" height="500"></canvas>
      <div id="genomeInfo" class="hint">Gesamtübersicht: SNP‑Verteilung über alle Chromosomen</div>
    </section>
  </main>
  <script>
    const E=s=>document.querySelector(s);
    const S={rows:[],byChr:new Map(),density:{},chrOrder:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","X","Y","MT"],zoomChr:null};
    S.chrOrder.forEach(c=>S.density[c]=0);
    function dprSetup(c){const r=window.devicePixelRatio||1;c.width=Math.max(1,Math.floor(c.clientWidth*r));c.height=Math.max(1,Math.floor(c.clientHeight*r));const x=c.getContext("2d");x.setTransform(r,0,0,r,0,0);return x}
    function log(m){const el=E('#status');el.textContent+="\n"+m;el.scrollTop=el.scrollHeight}
    function parse23andMe(t){const rows=[];const ls=t.split(/\r?\n/);for(const line of ls){if(!line||line[0]==="#")continue;const p=line.trim().split(/\t|\s+/);if(p.length<4)continue;const rsid=p[0],chrom=p[1],pos=+p[2],gt=(p[3]||"").toUpperCase();rows.push({rsid,chromosome:chrom,position:pos||0,genotype:gt})}return rows}
    function recompute(){S.byChr.clear();S.chrOrder.forEach(c=>S.density[c]=0);for(const r of S.rows){if(!S.byChr.has(r.chromosome))S.byChr.set(r.chromosome,[]);S.byChr.get(r.chromosome).push(r);if(S.density[r.chromosome]!=null)S.density[r.chromosome]++}}
    function drawIdeogram(){const c=E('#ideogram');const ctx=dprSetup(c);ctx.clearRect(0,0,c.clientWidth,c.clientHeight);const max=Math.max(1,...S.chrOrder.map(k=>S.density[k]||0));const W=c.clientWidth,H=c.clientHeight,pad=16,step=(W-2*pad)/S.chrOrder.length,barW=step*0.6;ctx.font='12px ui-monospace,Consolas,monospace';ctx.fillStyle='#9fb0c1';c.onclick=null;c.addEventListener('click',ev=>{const r=c.getBoundingClientRect();const mx=ev.clientX-r.left;const i=Math.max(0,Math.min(S.chrOrder.length-1,Math.floor((mx-pad)/step)));const chr=S.chrOrder[i];S.zoomChr=chr;drawZoom()});S.chrOrder.forEach((chr,i)=>{const v=S.density[chr]||0;const h=Math.round((H-40)*(v/max));const x=pad+i*step+(step-barW)/2;ctx.fillStyle='#203041';ctx.fillRect(x,H-22-h,barW,h);ctx.fillStyle='#9fb0c1';ctx.fillText(chr,x+barW/2-6,H-6)})}
    function drawZoom(){const c=E('#zoomCanvas');const ctx=dprSetup(c);ctx.clearRect(0,0,c.clientWidth,c.clientHeight);const chr=S.zoomChr||S.chrOrder[0];const rows=(S.byChr.get(chr)||[]).slice().sort((a,b)=>a.position-b.position);E('#zoomInfo').textContent=rows.length?`Chromosom ${chr} | SNPs ${rows.length.toLocaleString('de-DE')}`:`Chromosom ${chr} | keine Daten`;if(!rows.length){ctx.fillStyle='#9fb0c1';ctx.font='14px sans-serif';ctx.fillText('Keine Daten',10,24);return}const W=c.clientWidth,H=c.clientHeight,pad=16;const bins=60;const min=rows[0].position;const max=rows[rows.length-1].position||min+1;const binSize=Math.max(1,Math.floor((max-min+1)/bins));const counts=new Array(bins).fill(0);for(const r of rows){const i=Math.max(0,Math.min(bins-1,Math.floor((r.position-min)/binSize)));counts[i]++}const m=Math.max(1,...counts);const baseY=H-28,maxH=H-58,tileW=(W-2*pad)/bins;for(let i=0;i<bins;i++){const t=counts[i]/m;const h=Math.max(2,Math.round(maxH*t));const x=pad+i*tileW;ctx.fillStyle=`rgba(103,183,255,${(0.15+t*0.75).toFixed(3)})`;ctx.fillRect(x,baseY-h,Math.max(1,tileW-1),h)}ctx.strokeStyle='#203041';ctx.beginPath();ctx.moveTo(pad,baseY+0.5);ctx.lineTo(W-pad,baseY+0.5);ctx.stroke();ctx.fillStyle='#9fb0c1';ctx.font='12px ui-monospace,Consolas,monospace';ctx.fillText(String(min),pad,H-8);ctx.fillText(String(max),W-80,H-8)}
    function drawGenome(){const c=E('#genomeCanvas');const ctx=dprSetup(c);ctx.clearRect(0,0,c.clientWidth,c.clientHeight);const W=c.clientWidth,H=c.clientHeight,margin=40,rowH=(H-2*margin)/S.chrOrder.length;ctx.font='10px ui-monospace,Consolas,monospace';let globalMax=0;for(const r of S.rows){if(r.position>globalMax)globalMax=r.position}globalMax=Math.max(1,globalMax);S.chrOrder.forEach((chr,i)=>{const y=margin+i*rowH+rowH/2;ctx.fillStyle='#9fb0c1';ctx.fillText(chr,5,y+4);const arr=S.byChr.get(chr)||[];ctx.fillStyle='#67b7ff66';for(let j=0;j<arr.length;j+=1){const r=arr[j];const x=margin+(r.position/globalMax)*(W-2*margin);ctx.fillRect(x,y-2,1,4)}ctx.strokeStyle='#233142';ctx.beginPath();ctx.moveTo(margin,y);ctx.lineTo(W-margin,y);ctx.stroke()})}
    E('#file').addEventListener('change',async e=>{const f=e.target.files&&e.target.files[0];if(!f)return;E('#fileMeta').textContent=`Datei: ${f.name} (${(f.size/1e6).toFixed(2)} MB)`;log('Lese Datei …');const text=await f.text();S.rows=parse23andMe(text);log(`Importiert ${S.rows.length.toLocaleString('de-DE')} SNPs`);recompute();drawIdeogram();drawGenome();S.zoomChr=S.chrOrder.find(c=>(S.byChr.get(c)||[]).length>0)||S.chrOrder[0];drawZoom()});
    drawIdeogram();drawZoom();drawGenome();
  </script>
</body>
</html>
